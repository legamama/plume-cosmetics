# Netlify Deployment & Redirects

This document outlines the deployment process for the Plumé frontend and the build-time integration for handling redirects from Supabase.

## Overview

The Plumé frontend is deployed on Netlify. We use a **build-time** strategy to manage redirects:
1.  Redirects are managed in the Supabase `redirects` table (via Admin Dashboard).
2.  During the Netlify build, a script fetches all active redirects.
3.  A `_redirects` file is generated in the publish directory (`public/_redirects`).
4.  Netlify serves these redirects from the edge.

## Build Process

The `npm run build` command in `apps/frontend` is augmented to run the redirects generation script first.

### Commands
- **Local Dev**: The script is NOT run by default. You can run it manually via `npm run generate-redirects`.
- **Production**: `npm run build` will trigger `npm run generate-redirects` (defined in `package.json` scripts).

## Environment Variables

The following environment variables are required in Netlify Site Settings for the build script to function:

| Variable | Description |
|----------|-------------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase Project URL |
| `SUPABASE_SERVICE_ROLE_KEY` | **Secret** Service Role Key (needed to bypass RLS and fetch all redirects) |

> [!WARNING]
> Do NOT expose `SUPABASE_SERVICE_ROLE_KEY` to the client-side bundle. It is used ONLY during the build process in the Node.js environment.

## Triggering Updates

To update redirects without a full code deployment:

1.  **Admin Action**: Admin adds/updates redirects in the Dashboard.
2.  **Trigger Build**: Admin clicks "Publish Redirects" (or similar) which hits a Netlify Build Hook URL.
3.  **Netlify**: Re-runs the build, generating a fresh `_redirects` file.

## `_redirects` File Format

The generated file follows standard Netlify syntax:

```
# Generated by backend/scripts/generate-redirects-from-supabase.ts
/old-path  /new-path  301
/promo     /products/promo-item  302
```

## Troubleshooting

- **Redirect not working?** Check if the build has finished since you saved the redirect in Supabase.
- **Build failed?** Check the Netlify deploy logs for errors in the `generate-redirects` step. Ensure `SUPABASE_SERVICE_ROLE_KEY` is set.
